
## Source code

Windows : https://sourceforge.net/projects/sevenzip/files/7-Zip/

posix : https://sourceforge.net/projects/p7zip/files/p7zip/

## Compile Windows 7zip

Visual Studio 2012+

1 进入 CPP\7zip\Bundles\Format7zF

2 选择解决方案里的`7Z`项目后，点击菜单栏的`项目`->`生成自定义`，勾选`masm`，按`确定`选中项目里的 
`ASM\7zCrcOpt.asm` 和 `ASM\AesOpt.asm`，右键`属性`->`常规`->`项类型`，
 选择 `Microsoft Macro Assembler`，按`确定`,这点只对 x86 平台有效
 
 或者
 
 也可以去掉 asm 这种优化方式，去掉工程里这几个 asm 文件，把等价的 c 实现添加到工程。包括：
 `..\..\..\..\C\7zCrcOpt.c` ， `..\..\..\..\C\AesOpt.c`  并对这两个文件设置`不使用预编译头`。
	
3  `链接器`->`映像具有安全异常处理程序` => `否`

4 C/C++ -> 常规 -> 调试信息格式 => 程序数据库 (/Zi)

5  链接器 -> 常规-> 输出文件 => .\Debug\7z.dll


#### 与 7z 接口交互注意 CPropVariant

在自己的代码与 7z 接口交换数据时，指定使用`PROPVARIANT(CPropVariant)` 类型，当传递给 7z 的数据类型是 `const char *` 时，会被转为 `BSTR` ，转换过程为 7z 完成，查看 7z 代码发现转换的方式是直接字符 `assign` 复制，完全没考虑中文转换。所以，建议与之交互使用 `BSTR` ，`const char *` 的数据类型要在自己这边转为 `const wchar_t *` 继而传递给 7z，防止数据错误。


# P7Zip




## Download Source Code

homepage http://p7zip.sourceforge.net/

source code repo https://sourceforge.net/projects/p7zip/files/p7zip/16.02/

## Modification

1 `./CPP/Common/MyWindows.h:116 `
`struct IUnknown{} `

remove the   virtual ~IUnknown() {}

make sure the IUnkown defined same with Windows.

2 `./CPP/7zip/Crypto/MyAes.h`

a memory leak fix, 

I report at https://sourceforge.net/p/sevenzip/bugs/2030/

3 Make 7z.so support extract Rar

Step 1

`Utils/file_Codecs_Rar_so.py`
`Utils/file_7z_so.py`

The file `file_Codecs_Rar_so.py` content is a list of file to make Rar.so, add the list variable `files_c` and `files_cpp` to the `file_7z_so.py` two list variable(`files_c` and `files_cpp`).

Notice not add the file `CPP/7zip/Compress/DllExportsCompress.cpp` in `file_Codecs_Rar_so.py` `files_cpp` to `file_7z_so.py` `files_cpp`, this will occur a link problem.

As example,  add to  `file_7z_so.py` like this:
```python
for k in file_Codecs_Rar_so.files_c:
 if k not in files_c:
  files_c.append(k)

for k in file_Codecs_Rar_so.files_cpp:
 if k not in files_cpp and k.find("DllExportsCompress")==-1:
  files_cpp.append(k)
```

Step 2

in linux(not Windows), run `python Utils/generate.py`, this will make new compile used files.


You can check if 7z.so(debug mode compile) can extract Rar use IDA, search export function keyword  `CRegisterCodecsRar`, if it not have, then cannot extrace Rar, if have, then can extrace Rar. This keyword is generate by file `./CPP/7zip/Compress/RarCodecsRegister.cpp`, 
`CRegisterCodecsRar` is a global static variable. It will call `RegisterCodec` to register global static `g_Codecs`. Before add Rar, `g_NumCodecs` (the array size of `g_Codecs`) is  19, after add Rar, it will add `Rar1`,`Rar2`,`Rar3`,`Rar5`, `g_NumCodecs` is 23.

## Compile P7Zip

`make 7z -j8`

it will make 

```
bin/7z
bin/7z.so
bin/Codecs/Rar.so
```

## Debug P7Zip

file `makefile.machine` 

`OPTFLAGS=-O -s` => `OPTFLAGS=-g2`

`ALLFLAGS `-DNDEBUG => -DDEBUG -D_DEBUG -g 



### #如何删除一个文件
~~~
https://sourceforge.net/p/sevenzip/discussion/45798/thread/0334c6d0/
archive with 3 files:
1.txt
2.txt
3.txt
You want to delete 2.txt
So new archive will contain 2 files.
UpdateItems(numItems = 2)
GetUpdateItemInfo()
if (index == 0)
*newData = 0;
*newProps = 0;
*indexInArchive = 0;
if (index == 1)
*newData = 0;
*newProps = 0;
*indexInArchive = 2;

情景2
archive with 3 files:
1.txt
2.txt
3.txt
You want to delete 1.txt and 2.txt
So new archive will contain 1 file.
UpdateItems(numItems = 1)
GetUpdateItemInfo()
if (index == 0)
*newData = 0;
*newProps = 0;
*indexInArchive = 2; // it's index of 3.txt in original archive
~~~

### #能否 InArchive 和 OutArchive 都使用同一个文件？也就是说，更新文件时，不借助其他文件（比如临时文件）。
~~~
不能。
https://sourceforge.net/p/sevenzip/discussion/45798/thread/fbcee7f0/
作者批示：
Original input stream must be readonly.
So you can't use same stream as OutSrtream.
~~~